<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>壁紙診断</title> 
  <link rel="stylesheet" href="../style/question.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://code.jquery.com/jquery-migrate-3.3.2.js"></script>
  <script>
    jQuery.migrateMute = false;
  </script>
</head>

<body>
  <main>
    <span></span>
    <div class="selectedImages">
      <img id="S1" src="" onclick="choosedModal(0)">
      <img id="S2" src="" onclick="choosedModal(1)">
      <img id="S3" src="" onclick="choosedModal(2)">
      <img id="S4" src="" onclick="choosedModal(3)">
      <img id="S5" src="" onclick="choosedModal(4)">
      <img id="S6" src="" onclick="choosedModal(5)">
    </div>

    <br>
    <br>
    <div id="display_image">
      <div id="A1_block">
        <img id="A1" src="" onclick="answer(this.id)">
        <img src="../img/lupe.svg" style="width: 10vw; height: 10vw; background-color: white;" class="A1_lupe lupe" onclick="addLupeClickListener('A1')">
      </div>
      <div id="A2_block">
        <img id="A2" src="" onclick="answer(this.id)">
        <img src="../img/lupe.svg" style="width: 10vw; height: 10vw; background-color: white;" class="A1_lupe lupe" onclick="addLupeClickListener('A2')">
      </div>
      <div id="A3_block">
        <img id="A3" src="" onclick="answer(this.id)">
        <img src="../img/lupe.svg" style="width: 10vw; height: 10vw; background-color: white;" class="A1_lupe lupe" onclick="addLupeClickListener('A3')">
      </div>
      <div id="A4_block">
        <img id="A4" src="" onclick="answer(this.id)">
        <img src="../img/lupe.svg" style="width: 10vw; height: 10vw; background-color: white;" class="A1_lupe lupe" onclick="addLupeClickListener('A4')">
      </div>
    </div>
    <br>
    <div id="display_button">
      <input type="button" onclick="back()" value="１つ戻る">
      <input type="button" onclick="answer('A0')" value="好みなし">
    </div>
    <div class="tecido">
      <h4><p class="cooperation_companies">画像提供 : 株式会社テシード</p></h4>
      <img class="tecido_logo" src="../img/tecido_logo.png">
    </div>
  </main>

  <script src="../store/score.js"></script>

  <script>
    let count = 1;
    let question_num = 6;
    let names = Array.from({ length: 6 }, () => Array(4).fill(null));
    let selectedImages = Array(question_num).fill("../img/question_mark.png");

    function updateProgressBar() {
      let progress_value = (count / question_num) * 100;
      $("#progressbar").progressbar({
        value: progress_value
      });
      $("#progressbar").find(".ui-progressbar-value").css({
        'background': '#00BFFF'
      });
      $("#progressbar").css({
        'border-radius': '100vh'
      });
    };

    const score = new scoreStore();

    window.addEventListener('load', async function () {
      console.log("load：リソースファイルを全て読み込みました.");
      const imageContainer = document.getElementById("image-container");

      let result = await getQuestion();
      if (result) {
        console.log("APIを6回たたけた");
        console.log("names");
        console.log(names);
        for (let i = 0; i < names[0].length && i < 4; i++) {
          const imageElement = document.getElementById("A" + (i + 1));
          console.log("A" + (i + 1) + "の取得");
          console.log(imageElement);
          console.log(names[0][i]);
          imageElement.src = "http://35.187.199.64/image?name=" + names[0][i] + "&mode=2";
          //  //虫眼鏡の処理追加
          //  addLupeClickListener("A" + (i + 1), names[0][i]);
        }
      } else {
          alert("問題の取得に失敗しました");
      }
  });

    async function getQuestion() {
      for (let n = 0; n < question_num; n++) {
        try {
          const response = await fetch("http://35.187.199.64/question?num=" + (n + 1));
          if (!response.ok) {
            throw new Error("ネットワーク応答が正常ではありませんでした");
          }
          console.log("loop=" + n);
          const result = await response.json();
          for (let v = 0; v < result.names.length && v < 4; v++) {
            names[n][v] = result.names[v];
          }
        } catch (error) {
          console.error("データの取得中にエラーが発生しました:", error);
          return false;
        }
      }
      return true;
    }

    function addLupeClickListener(elementId) {
    const imageElement = document.getElementById(elementId);
    const imageSrc = imageElement.src;

    // Extract the substring between "name=" and "&mode=2"
    const startIndex = imageSrc.indexOf("name=") + 5;
    const endIndex = imageSrc.indexOf("&mode=2");
    const extractedName = imageSrc.substring(startIndex, endIndex);

    console.log("Extracted name =", extractedName);

    // Now you can use 'extractedName' as needed
    var x = "http://35.187.199.64/image?name=" + extractedName + "&mode=1"; // リサイズ
    var y = "http://35.187.199.64/image?name=" + extractedName + "&mode=3"; // ３ｄ
    displayModal(x, y, "");
}


    score.setScore({ choices: [] });

    function answer(id) {
      let storedScores = score.getScore();
      id = id[1];
      if (id == "0") {
        selectedImages[count - 1] = "../img/bad_luck.png"
        storedScores.choices.push("");
        score.setScore(storedScores);
      } else {
        selectedImages[count - 1] = "http://35.187.199.64/image?name=" + names[count - 1][id - 1] + "&mode=2";
        console.log("storedScores.choices")
        storedScores.choices.push(names[count - 1][id - 1]);
        console.log(storedScores.choices);
        score.setScore(storedScores);
      }
      count++;

      console.log(score.getScore());

      if (count <= question_num) {
        setImage();
        getImage();
      } else {
        window.location.href = "result.html"
      }
    }

    function setImage() {
      console.log("setImage");
      for (let i = 0; i < names[count-1].length && i < 4; i++) {
        const imageElement = document.getElementById("A" + (i + 1));
        imageElement.src = "http://35.187.199.64/image?name=" + names[count-1][i] + "&mode=2";
        //虫眼鏡の処理追加
        console.log("A"+(i+1)+"_lupe")
        const LopeElement = document.createElement("A"+(i+1)+"_lupe");
          if(LopeElement){
            LopeElement.addEventListener("click", function () {
              var x="http://35.187.199.64/image?name="+names[count-1][i]+"&mode=1";//リサイズ
              var y="http://35.187.199.64/image?name="+names[count-1][i]+"&mode=3";//３ｄ
              displayModal(x,y,"");//names[0][i]はオリジナルネームを入れたい
              console.log("modal追加");
            });
            //ここまで
          }else{
            console.log("LopeElementなし")
          }
      }
    }

    function getImage() {
      for (let i = 0; i < question_num; i++) {
        let name = "S" + String(i + 1)
        const imgElement = document.getElementById(name);
        imgElement.src = selectedImages[i];
      }
    }

    function delImage() {
      selectedImages[count - 2] = "../img/question_mark.png"
      getImage();
    }

    function back() {
      if (count > 1) {
        delImage();
        count--;
        let storedScores = score.getScore();
        let last = storedScores.choices.pop();
        console.log(last);
        console.log("↑削除");
        score.setScore(storedScores);
        console.log(score.getScore());
        console.log("↑最新");
        updateProgressBar();
        setImage();
      } else {
        alert("1つ以上答えて下さい")
      }
    }

    function choosedModal(num){
      let storedScores = score.getScore();
      console.log("choosedModal num = "+ num);
      console.log("storedScores.choices");
      console.log(storedScores.choices);
      if(storedScores.choices[num]){
        var num_image = storedScores.choices[num];
        console.log("モーダル");
        console.log(num_image);
        var x="http://35.187.199.64/image?name="+num_image+"&mode=1";//リサイズ
        var y="http://35.187.199.64/image?name="+num_image+"&mode=3";//３ｄ
      }else{
        console.log("画像はない");
        var x = "../img/question_mark.png";
        var y = "../img/question_mark.png";
      }
      displayModal(x,y, "");
    }

    function displayModal(resizedUrl, threeDUrl, wallName) {
      let isResizedImageShown = true;  // 最初はリサイズされた画像を表示

      const modal = document.createElement("div");
      modal.className = "modal";
      modal.style.display = 'block';

      const modalContent = document.createElement("div");
      modalContent.className = "modal-content";

      const image = document.createElement("img");
      image.src = resizedUrl;  // 最初に表示する画像
      image.style.width = '300px';  // 画像サイズの指定
      modalContent.appendChild(image);

      //
      if(wallName != ""){
        const wallNameText = document.createElement("p");
        wallNameText.textContent = "壁紙の名前: " + wallName;

        const Textbr = document.createElement("br");
        wallNameText.appendChild(Textbr);

        const link = document.createElement("a");
        link.href = "https://www.tecido.co.jp/products/search/?q=" + wallName + "&r=item%3AITEM%3A129%2Ctype%3ATYPE%3A2";
        link.textContent = "商品ページはこちら";
        link.target = "_blank"; // 新しいタブまたはウィンドウで開く
        wallNameText.appendChild(link);
        modalContent.appendChild(wallNameText);
      }
      //
      modal.appendChild(modalContent);

      const arrow = document.createElement("p");
      arrow.className = "arrow sample1-4 s2";
      // arrow.className = "sample1-4 s2 box";
      modal.appendChild(arrow);

      document.body.appendChild(modal);

      modal.addEventListener("click", function () {
        //modal.remove();
        
          // 画像をクリックしたときのイベントハンドラ
        image.addEventListener("click", function (e) {
          e.stopPropagation();  // イベントの伝播を停止

          const width = image.clientWidth; // 画像の幅
          const x = e.offsetX; // クリックされたX座標

          // 画像の右半分をクリックした場合にのみ切り替える
          if (x > width / 2) {
            if (isResizedImageShown) {
              image.src = threeDUrl;  // 3D画像に切り替え
              isResizedImageShown = false;
            } else {
              image.src = resizedUrl;  // リサイズされた画像に戻す
              isResizedImageShown = true;
            }
          } else {
            if (!isResizedImageShown) {
              image.src = resizedUrl;  // リサイズされた画像に戻す
              isResizedImageShown = true;
            }
          }
        });

      });

      // 画像をクリックしたときのイベントハンドラ
      image.addEventListener("click", function (e) {
        e.stopPropagation();  // イベントの伝播を停止

        const width = image.clientWidth; // 画像の幅
        const x = e.offsetX; // クリックされたX座標

        // 画像の右半分をクリックした場合にのみ切り替える
        if (x > width / 2) {
          if (isResizedImageShown) {
            image.src = threeDUrl;  // 3D画像に切り替え
            isResizedImageShown = false;
          } else {
            image.src = resizedUrl;  // リサイズされた画像に戻す
            isResizedImageShown = true;
          }
        } else {
          if (!isResizedImageShown) {
            image.src = resizedUrl;  // リサイズされた画像に戻す
            isResizedImageShown = true;
          }
        }
      });

      // モーダルをクリックしたときに閉じる
      modal.addEventListener("click", function () {
        modal.style.display = 'none';
        modal.remove();
      });
    }

    $(function () {
      updateProgressBar();
      setImage();
      getImage();
    });

  </script>
  <style>
    .arrow {
      position: relative;
      display: inline-block;
      color: #000;
      font-size: 50px;
      z-index: 1000; /* 追加 */
      top: 50vh; /* 修正: y座標を50vhに指定 */
    }

    .arrow.sample1-4 {
      position: relative;
      display: inline-block;
      color: #000;
      font-size: 50px;
      z-index: 1000; /* 追加 */
      transform: translate(-50%, -50%); /* 中央揃え */
    }

    .arrow.sample1-4::before {
      position: absolute;
      content: "";
      z-index: 999; /* 追加 */
      left: 30%; /* 中央から 30% 左に配置 */
      top: 40%; /* 中央に配置 */
      transform: translateX(-50%); /* 左端を中央に移動 */
      width: 100px;
      height: 30px;
      background: rgb(255, 213, 0, 1);
    }

    .arrow.sample1-4::after {
      position: absolute;
      content: "";
      z-index: 999; /* 追加 */
      left: calc(50% - 70px); /* 中央から 5px 左に配置 */
      top: calc(50% - 40px); /* 中央から 30px 上に配置 */
      transform: translateX(-50%); /* 左端を中央に移動 */
      width: 80px;
      height: 80px;
      border-top: 30px solid rgb(255, 213, 0, 1);
      border-right: 30px solid rgb(255, 213, 0, 1);
      -webkit-transform: rotate(-140deg); /* 逆方向に回転 */
      transform: rotate(-140deg); /* 逆方向に回転 */
    }

    .s2 {
      animation: anim2 2s infinite;
    }

    @keyframes anim2 {
      0% {
        transform: translateX(90vw);
      }

      100% {
        transform: translateX(75vw);
      }
    }
  </style>
</body>

</html>
